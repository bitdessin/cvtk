Object Detection
################

This tutorial is for building an object detection model using the cvtk package.
Note that, MMDetection package is internally used in cvtk for object detection.

Source Code Preparation
***********************

To generate Python source code, use the :command:`cvtk create` command.
For those new to deep learning,
it is recommended to run the following command to generate simple source code.
he code generated by this command contains only the essential processes,
with all complex processes imported from the cvtk package.
This makes the source code easy to read and helps in understanding the flow of deep learning.


.. code-block:: sh
    
    cvtk create --project cls.py --type det


The source code generated by the above command is simple but difficult to customize.
If you want to add various processes,
such as data augmentation, optimization algorithms, and loss functions,
run :command:`cvtk create` command with argument :command:`--module mmdet` to generate source code
that is complete using only the torch package functions.


.. code-block:: sh
    
    cvtk create --project cls.py --type det --module mmdet




Model Training and Validation
*****************************

To train the model,
open the source code generated above and execute it
by providing training data, validation data,
and test data to the input of the :code:`train` function.
It can also be executed directly from the command line as follows:



.. code-block:: sh

    python cvtkscript.py train \
        --dataclass ./data/strawberry/class.txt \
        --train ./data/strawberry/train/annotations.json \
        --valid ./data/strawberry/valid/annotations.json \
        --test ./data/strawberry/test/annotations.json \
        --output_weights ./output/strawberry.pth


The weights of the trained model will be saved in :file:`strawberry.pth`,
and the loss and accuracy data during the training process
will be saved in :file:`strawberry.train_stats.train.txt` and  :file:`strawberry.train_stats.valid.txt`.


If one wants to visualize the changes in loss and accuracy during the training process,
open the source code and add the code for plotting the graph
at the end of the train function (i.e., below the :code:`save` function).
For example, as follows:


.. code-block:: py

    def train(dataclass, train, valid, test, output_weights, batch_size=4, num_workers=8, epoch=20):
        
        # ...
        # ...
        # ...

        model.train(train, valid, test, epoch=epoch)
        model.save(output_weights)
        
        output_prefix = os.path.splitext(output_weights)[0]
        
        fig = cvtk.ml.mmdet.plot_trainlog(
            os.path.join(output_prefix, '.train_stats.train.txt'),
            output=os.path.join(output_prefix, '.train_stats.train.png'))
        fig.show()

        fig = cvtk.ml.mmdet.plot_trainlog(
            os.path.join(output_prefix, '.test_outputs.valid.txt'),
            output=os.path.join(output_prefix, '.train_outputs.valid.png'))
        fig.show()



Inference
*********

To perform inference using the constructed model,
refer to the :code:`inference` function in the source code.
It can also be executed directly from the command line as follows:


.. code-block:: sh

    python cls.cvtk.py inference \
        --dataclass ./data/fruits/class.txt \
        --data ./data/fruits/test.txt \
        --model_weights ./output/strawberry.pth \
        --output ./output/strawberry_inference_results.txt


